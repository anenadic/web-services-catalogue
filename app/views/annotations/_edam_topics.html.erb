<%

   # BioCatalogue: app/views/annotations/_categories.html.erb
   #
   # Copyright (c) 2009-2011, University of Manchester, The European Bioinformatics
   # Institute (EMBL-EBI) and the University of Southampton.
   # See license.txt for details

%>

<%
   # Set defaults for optional parameters to this partial...
   show_add_option = true unless local_assigns.has_key?(:show_add_option)
   show_modify_options = true unless local_assigns.has_key?(:show_modify_options)
   small = false unless local_assigns.has_key?(:small)
   show_title = true unless local_assigns.has_key?(:show_title)
   show_none = true unless local_assigns.has_key?(:show_none)
%>

<div class="annotations_container">

  <div class="edam_topics_box">
    <table style="width: auto;">
      <tr>
        <% if show_title %>
            <td style="vertical-align: top; padding-right: 0.6em; <%= small ? 'font-size: 85%;' : '' -%>">
              <span><b>EDAM ontology topics: </b></span>
            </td>
        <% end %>
        <td style="vertical-align: top;">

          <% if !((edam_annotations = service.annotations_with_attribute("edam_topic")).empty?) then %>
              <ul class="edam_topics">
                <% edam_annotations.each do |edam_annotation| %>
                    <% edam_topic = edam_annotation.value %>
                    <% unless edam_topic.nil? %>
                        <li>
										<span class="main">
											<%= link_to(h(remove_formatting_of(edam_topic.text)),
                                                        services_path(:edam => "[#{edam_annotation.id}]"),
                                                        :class => "edam_topic",
                                                        :style => (small ? 'font-size: 85%;' : ''),
                                                        :title => tooltip_title_attrib(edam_hierachy_text(edam_topic.text))) -%>

                                          <% if show_modify_options %>
												<% if BioCatalogue::Auth.allow_user_to_curate_thing?(current_user, edam_annotation) %>
													<span style="margin-left: 0.2em;">
														<%= link_to(icon_faded_with_hover(:delete),
                                                                    annotation_path(edam_annotation),
                                                                    :method => :delete,
                                                                    :confirm => "Are you sure you want to delete this EDAM ontology topic?",
                                                                    :style => 'vertical-align: baseline;',
                                                                    :title => tooltip_title_attrib("Delete this EDAM ontology topic")) -%>
													</span>
												<% end %>
											<% end %>
										</span>
                        </li>
                    <% end %>
                <% end %>
              </ul>
          <% else %>
              <% if show_none %>
                  <div class="none_text" style="padding-right: 1em; <%= small ? 'font-size: 85%;' : '' -%>">
                    <span style="margin-right: 2em; ">none</span>
                    <%= link_to("Help categorise this service with EDAM topics...", "#{service_path(service)}?categorise") -%>
                  </div>
              <% end %>
          <% end %>

        </td>

        <% if show_add_option %>
            <td style="width: 160px; vertical-align: top; padding-top: 3px; padding-left: 5px;">

						<span class="add_option" style="vertical-align: middle;">
							<% if logged_in? %>

								<%= content_tag(:span,
                                                image_tag('add_annotation_inactive.png', :style => 'vertical-align:middle;margin-right:0.3em;'),
                                                :class => "inactive",
                                                :style => "vertical-align: middle;") -%>

                              <% link_text = image_tag('add_annotation_hover.png', :style => 'vertical-align:middle;margin-right:0.3em;') +
                                      content_tag(:span, "Add EDAM topics", :style => "vertical-align: middle; text-decoration: underline;") %>
                              <%= link_to_function(link_text + expand_image,
                                                   visual_effect(:toggle_slide, "add_edam_topic_box", :duration => 0.3),
                                                   :class => "active",
                                                   :style => "text-decoration: none; vertical-align: middle;") %>

							<% else %>

								<%= content_tag(:span,
                                                image_tag('add_annotation_inactive.png', :style => 'vertical-align:middle;margin-right:0.3em;'),
                                                :class => "inactive",
                                                :style => "vertical-align: middle;") -%>

                              <%= link_to(login_path, :class => "active", :style => "text-decoration: none; vertical-align: middle; width: 250px;", :title => tooltip_title_attrib("Log in to add EDAM topics")) do -%>
									<%= image_tag('add_annotation_inactive.png', :style => 'vertical-align:middle;margin-right:0.2em;') %>
                                  <%= content_tag(:span, "Log in to add EDAM topics", :style => "vertical-align: middle; text-decoration: underline; width: 250px;") -%>
								<% end %>

							<% end %>
						</span>

            </td>
        <% end %>

      </tr>
    </table>

  </div>

  <% if show_add_option and logged_in? %>
      <div id="add_edam_topic_box" class="box_form" style="width: 550px; margin: 1em 0; display: <%= params.has_key?(:categorise) ? 'block' : 'none' -%>;">
        <%= form_for :annotation, :url => add_ontology_annotation_service_url(service) do |f| %>
            <input id="selected_edam_topics_input" type="hidden" name="categories"/>

            <p style="margin-bottom: 0.5em;">
              <b>Annotate with EDAM ontology topics:</b>
              <%= info_icon_with_tooltip("Here you can specify what EDAM topics this service can be classified under. You can set more than one, but please try and be as specific as possible.") -%>
            </p>

            <div id="selected_edam_topics_list" class="form_selected_values">
              <i>None</i>
            </div>
            <p style="margin-top: 0.7em;">
              <%= ontology_select_tag f, 'edam', 'edam', 'edam_uri' -%>
              <b><a href="#" onclick="javascript:addEdamTopics('annotation_edam'); return false;" class="button_slim" style="margin-left: 0.6em; padding: 0.2em 0.4em;"><span>Add to list</span></a></b>
            </p>

            <p style="text-align: center;">
              <%= f.submit "Submit", :disable_with => "Submitting..." -%>
            </p>
        <% end %>
      </div>
  <% end %>
</div>

